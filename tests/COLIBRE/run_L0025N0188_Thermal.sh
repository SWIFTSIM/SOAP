#!/bin/bash
#
# This runs SOAP on a few halos in the L0025N0376/Thermal_fiducial
# box on Cosma8. It can be used as a quick test of new halo property
# code. Takes ~2 minutes to run.
#
# Should be run from the SOAP source directory. E.g.:
#
# cd SOAP
# ./tests/FLAMINGO/run_L0025N0376_Thermal_fiducial.sh
#

module purge
module load python/3.12.4 gnu_comp/14.1.0 openmpi/5.0.3 parallel_hdf5/1.12.3
source openmpi-5.0.3-hdf5-1.12.3-env/bin/activate

# Which simulation to do
sim="L0025N0188/Thermal"

# Snapshot number to do
snapnum=0092

# Halo indices to do: all halos with x<5, y<5, and z<5 cMpc in snap 92
halo_indices="17079 20065 22326 27035 27037 34951 36275 39305 40463 40495 44619 45938 45939 48451 49639 49646 49657 51919 51938 53031 56226 57389 60474 61533 62532 64282 67777 67801 68350 69437 69897 70019 70400 71432 71975 72461 72943 73459 73932 73939 73962 74036 74440 75916 7 819 1684 1689 2295 3231 3232 5123 5928 5954 6828 6853 6863 7859 8930 8932 10191 11482 11496 11499 11507 12942 12951 14444 16066 16096 16097 19060 19077 20095 21208 21212 21218 23496 25868 25870 25872 26584 27042 28291 29610 30883 30942 32234 32268 33601 34967 34986 36282 37688 37689 37699 37710 37711 39117 41890 41892 43234 44574 44576 44589 44598 44599 45947 45948 47198 47200 47208 48449 48461 49654 50787 50788 50798 51921 51967 51974 54152 54699 55224 55227 56283 56284 57383 57385 57386 57392 59473 59476 62536 62546 62547 63591 64274 64917 66673 66675 66697 67779 67781 68342 68911 69426 69430 69432 70953 70955 72942 72948 72950 73452 73931 73933 74460 75423 75424 39078 47222 61547 73961 821 6842 12933 14454 14459 16071 27065 28285 29595 29612 33595 36311 39103 43263 45950 45954 53065 54100 56277 60517 61497 62524 62554 63595 63987 64286 64920 64921 65527 66694 67786 70404 71417 71420 71968 73941 74448 74945 75903 3380 3381 5116 5128 5133 9138 14494 14732 16055 16241 18094 19219 19222 24819 24846 28564 28566 28569 31201 32240 33597 34944 37694 43240 45927 47203 48440 48446 49637 50805 53029 53033 54146 55183 55186 55189 55195 55405 56258 60703 61536 61759 63763 64294 64307 65631 66120 66122 67241 68344 68905 69436 69438 70394 70954 70957 71430 72453 72454 72962 72963 73935 73945 73963 74438 74441 75415 75918 5939 18100 22345 32291 55169 55194 71418 72951 30929 57361 62589 67803 36297 50822 67788 68347 69899"

# Create parameters files
python tests/COLIBRE/create_parameters_file.py

# Remove tmp directory (so we don't load chunks if they already exist)
rm -r output/SOAP-tmp

# Run SOAP on eight cores processing the selected halos. Use 'python3 -m pdb' to start in the debugger.
mpirun -np 8 python3 -u -m mpi4py SOAP/compute_halo_properties.py \
       ./tests/COLIBRE/test_parameters.yml \
       --halo-indices ${halo_indices} \
       --sim-name=${sim} --snap-nr=${snapnum} --chunks=1

